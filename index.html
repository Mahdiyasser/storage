<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Storage Utility</title>
    <style>
        /* Keep the page completely invisible to the end-user */
        body {
            background-color: transparent;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            /* Optional: Display a small message for debugging */
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: sans-serif;
            font-size: 10px;
            color: #6b7280; /* Gray-500 */
        }
    </style>
</head>
<body>
    <p>Storage Utility Running on storage.mahdiyasser.site</p>
    
    <script>
        /**
         * Checks if the incoming message is from a valid origin within the mahdiyasser.site family.
         * Allows 'mahdiyasser.site' itself, or any subdomain ending in '.mahdiyasser.site'.
         * @param {string} origin - The origin URL of the message sender.
         * @returns {boolean} - True if the origin is authorized.
         */
        function isAuthorizedOrigin(origin) {
            // Use URL object for reliable domain parsing
            try {
                const url = new URL(origin);
                const hostname = url.hostname;
                
                // Allow the root domain and all subdomains of mahdiyasser.site
                return hostname === 'mahdiyasser.site' || hostname.endsWith('.mahdiyasser.site');
            } catch (e) {
                console.error("Invalid origin format:", origin);
                return false;
            }
        }

        /**
         * The core event listener for handling commands from parent windows.
         */
        window.addEventListener('message', (event) => {
            // 1. SECURITY CHECK: Validate the origin of the message using the authorization function.
            if (!isAuthorizedOrigin(event.origin)) {
                console.error("Storage Utility: Rejected message from unauthorized origin:", event.origin);
                return;
            }

            const data = event.data;

            if (!event.source || !data || !data.command) {
                console.warn("Storage Utility: Received invalid data or missing command.", data);
                return;
            }

            let response = {
                command: data.command,
                success: false,
                data: null,
                id: data.id // Pass the original command ID back for the caller to track
            };

            try {
                switch (data.command) {
                    case 'SAVE':
                        // Payload: { key: 'uniqueKey', value: 'dataToStore' }
                        if (data.payload && data.payload.key && data.payload.value) {
                            localStorage.setItem(data.payload.key, data.payload.value);
                            response.success = true;
                            response.message = `Key '${data.payload.key}' saved.`;
                        } else {
                            response.message = 'Invalid payload for SAVE command (requires key and value).';
                        }
                        break;

                    case 'RETRIEVE':
                        // Payload: { key: 'uniqueKey' }
                        if (data.payload && data.payload.key) {
                            const value = localStorage.getItem(data.payload.key);
                            response.success = true;
                            response.data = value; // data will be null if key is not found
                            response.message = value !== null ? `Key '${data.payload.key}' retrieved.` : 'Key not found.';
                        } else {
                            response.message = 'Missing key for RETRIEVE command.';
                        }
                        break;

                    case 'DELETE':
                        // Payload: { key: 'uniqueKey' }
                        if (data.payload && data.payload.key) {
                            localStorage.removeItem(data.payload.key);
                            response.success = true;
                            response.message = `Key '${data.payload.key}' deleted.`;
                        } else {
                            response.message = 'Missing key for DELETE command.';
                        }
                        break;

                    default:
                        response.message = 'Unknown command received.';
                        break;
                }
            } catch (e) {
                console.error("Storage Utility Error:", e);
                response.success = false;
                response.message = 'An internal storage error occurred.';
            }

            // 2. SEND RESPONSE: Post the result back to the sender
            // We use event.source.postMessage to reply directly to the sender.
            event.source.postMessage(response, event.origin);
        });

        // Inform the parent window (if any) that the iframe is ready
        window.onload = function() {
            if (window.parent !== window) {
                // Since we don't know the exact parent origin, we send * to announce readiness.
                // However, the listener on the parent side must still check the origin.
                // We'll trust the parent to check the origin of this "READY" message.
                window.parent.postMessage({ command: 'READY', origin: window.location.origin }, '*');
            }
        };

    </script>
</body>
</html>
